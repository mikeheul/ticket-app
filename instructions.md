# Ticket App Instructions

- [Ticket App Instructions](#ticket-app-instructions)
  - [Installation](#installation)
  - [Extensions](#extensions)
  - [Steps](#steps)
    - [Frontend](#frontend)
    - [Backend](#backend)
      - [Packages](#packages)
      - [Configuration](#configuration)


## Installation
``` bash 
npx create-next-app@latest (TypeScript no)
```
``` bash 
npm run dev
```

## Extensions
- **ES7+ React/Redux/React-Native snippets** (dsznajder)
- **EsLint** (Microsoft)
- **Tailwind CSS IntelliSense** (Tailwind Labs)

## Steps

### Frontend

- Clear all code in globals.css file
- Rename app/page.js in page.jsx -> rafce with Dashboard component
- Create a new folder TicketPage with page.jsx -> rafce with TicketPage component (we can navigate on each page with localhost:3000/TicketPage)
- Create a new folder inside TicketPage folder : [id] and move page.jsx in this folder
- Add {params} in TicketPage component and params.id : we can add id on URL parameters like localhost:3000/TicketPage/1

``` javascript
const TicketPage = ({ params }) => {
  return (
    <div>TicketPage {params.id}</div>
  )
}

export default TicketPage
```
- Add a (components) folder in app and a new file Nav.jsx (rafce)
- Modifiy layout.js
  
``` javascript
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "Ticket App", // update app title
  description: "Generated by me", // update app description
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  );
}
```
- To add a Navbar inside each page : update layout.js
``` javascript
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "Ticket App", // update app title
  description: "Generated by me", // update app description
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <Nav /> <!-- new Nav component -->
        {children}
      </body>
    </html>
  );
}
```
- Be careful to imports
``` javascript
import Nav from "./(components)/Nav";
```

- Install dependancies "Free solid SVG Icons" and "React FontAwesome"
``` bash
npm install @fortawesome/free-solid-svg-icons @fortawesome/react-fontawesome
```

- In tailwind.config.js, change colors theme
``` javascript
 theme: {
    extend: {
      backgroundImage: {
        "gradient-radial": "radial-gradient(var(--tw-gradient-stops))",
        "gradient-conic":
          "conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))",
      },
      // theme colors
      colors : {
        nav: "#18222f",
        page: "#2b3441",
        card: "#47566a",
        "card-hover": "#4f5e74",
        "default-text": "#f1f3f5",
        "blue-accent": "#0084d4",
        "blue-accent-hover": "#009fff"
      }
    },
  },
```

- Import new dependancies in layout.js
``` javascript
import {config} from "@fortawesome/fontawesome-svg-core";
import "@fortawesome/fontawesome-svg-core/styles.css";

config.autoAddCss = false;
```
- Update layout.js with tailwind classes and custom classes (bg-page and text-default-text)
``` javascript
export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <main className="flex flex-col h-screen max-h-screen">
          <Nav />
          <div className="flex-grow overflow-y-auto bg-page text-default-text">{children}</div>
        </main>
      </body>
    </html>
  );
}
```

- Update Nav component in Nav.jsx
``` javascript
import { faHome, faTicket } from "@fortawesome/free-solid-svg-icons"
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome"
import Link from "next/link"

const Nav = () => {
  return (
    <nav>
        <div>
            <Link href="/">
                <FontAwesomeIcon icon={faHome} className="icon" />
            </Link>
            <Link href="/TicketPage/new">
                <FontAwesomeIcon icon={faTicket} className="icon" />
            </Link>
        </div>
        <div>
            <p className="text-default-text">micka@exemple.com</p>
        </div>
    </nav>
  )
}

export default Nav
```

- Update globals.css to create "icon" class (on Link component in Nav.jsx)
``` css
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer components {
    .icon {
        @apply text-default-text text-xl;
    }
    .btn {
        @apply hover:no-underline bg-blue-accent hover:bg-dash-accent-hover tracking-wider w-full text-center text-nav font-bold cursor-pointer uppercase px-4 py-2 rounded-md transition-colors block;
    }
}
```

- Update Nav component
``` javascript
const Nav = () => {
  return (
    <nav className="flex justify-between bg-nav p-4">
        <div className="flex items-center space-x-4">
            <Link href="/">
                <FontAwesomeIcon icon={faHome} className="icon" />
            </Link>
            <Link href="/TicketPage/new">
                <FontAwesomeIcon icon={faTicket} className="icon" />
            </Link>
        </div>
        <div>
            <p className="text-default-text">micka@exemple.com</p>
        </div>
    </nav>
  )
}
```

- Create a new component : DeleteBlock.jsx
``` javascript
import { faX } from "@fortawesome/free-solid-svg-icons"
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome"

const DeleteBlock = () => {
  return (
    <FontAwesomeIcon 
        icon={faX} 
        className="text-red-400 hover:cursor-pointer hover:text-red-200"
    />
  )
}

export default DeleteBlock
```

- Create a new component : TicketCard.jsx and update Dashboard component (page.jsx)
``` javascript
import DeleteBlock from "./DeleteBlock"

const TicketCard = () => {
    return (
        <div>
        <DeleteBlock />
    </div>
  )
}

export default TicketCard
```
``` javascript
import TicketCard from "./(components)/TicketCard"

const Dashboard = () => {
  return (
    <div>
      <TicketCard />
      <TicketCard />
      <TicketCard />
    </div>
  )
}

export default Dashboard
```

- Create a PriorityDisplay component (rafce)
``` javascript
import { faFire } from "@fortawesome/free-solid-svg-icons"
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome"

const PriorityDisplay = () => {
  return (
    <div className="flex justify-start align-baseline">
        <FontAwesomeIcon icon={faFire} className="text-red-400"/>
        <FontAwesomeIcon icon={faFire} className="text-red-400"/>
        <FontAwesomeIcon icon={faFire} className="text-red-400"/>
        <FontAwesomeIcon icon={faFire} className="text-red-400"/>
        <FontAwesomeIcon icon={faFire} className="text-red-400"/>
    </div>
  )
}

export default PriorityDisplay
```

- Update TicketCard component
``` javascript
const TicketCard = () => {
  return (
    <div>
        <DeleteBlock />
        <PriorityDisplay />
    </div>
  )
}
```

- Create ProgressDisplay and StatusDisplay components
``` javascript
const ProgressDisplay = () => {
  return (
    <div className="w-full bg-gray-200 rounded-full h-2.5">
      <div 
        className="bg-blue-600 h-2.5 rounded-full" 
        style={{ width: "75%" }}>
      </div>
    </div>
  )
}

export default ProgressDisplay
```
``` javascript
const StatusDisplay = () => {
  return (
    <span className="inline-block rounded-full px-2 py-1 text-xs font-semibold text-gray-700 bg-green-200">
        done
    </span>
  )
}

export default StatusDisplay
```

- Update TicketCard component and globals.css

``` css
/* base layer (<-> root in native CSS) */ 
@layer base {
    h1,
    h2,
    h3,
    h4 {
        @apply font-bold;
    }

    h1 {
        @apply text-4xl
    }
    h2 {
        @apply text-3xl
    }
    h3 {
        @apply text-2xl
    }
    h4 {
        @apply text-xl
    }
    p {
        @apply text-sm text-default-text;
    }
}
```

``` javascript
const TicketCard = () => {
  return (
    <div className="flex flex-col bg-card hover:bg-card-hover rounded-md shadow-lg p-3 m-2">
        <div className="flex mb-3">
            <PriorityDisplay />
            <div className="ml-auto">
                <DeleteBlock />
            </div>
        </div>
        <h4>Ticket Title</h4>
        <hr className="h-px border-0 bg-page mb-2"/>
        <p className="whitespace-pre-wrap">
            this is the ticket description
        </p>
        <div className="flex-grow"></div>
        <div className="flex mt-2">
            <div className="flex flex-col">
                <p className="text-xs my-1">01/01/2024 10:00PM</p>
                <ProgressDisplay />
            </div>
            <div className="ml-auto flex items-end">
                <StatusDisplay />
            </div>
        </div>
    </div>
  )
}
```

- Update dashboard responsive design with tailwind breakpoints
``` javascript
const Dashboard = () => {
  return (
    <div className="p-5">
      <div className="lg:grid grid-cols-2 xl:grid-cols-4">
        <TicketCard />
        <TicketCard />
        <TicketCard />
        <TicketCard />
        <TicketCard />
      </div>
    </div>
  )
}
```

### Backend

#### Packages
``` bash
npm install mongodb mongoose
```

#### Configuration
- root folder : .env.local with database connection string 
```
MONGODB_URI=mongodb://localhost:27017/ticketDB
```

- In app folder, create a (modules) folder and Ticket.js to implement Schema
``` javascript
import mongoose, {Schema} from "mongoose";

mongoose.connect(process.env.MONGODB_URI);
mongoose.Promise = global.Promise;

const ticketSchema = new Schema(
    {
        title: String,
        description: String,
        category: String,
        priority: Number,
        progress: Number,
        status: String,
        active: Boolean
    },
    {
        timestamps: true,
    }
)

const Ticket = mongoose.models.Ticket || mongoose.model("Ticket", ticketSchema);
export default Ticket;
```

- Create an "api" and "Tickets" folder (in app) and "route.js" inside it

``` javascript
import Ticket from "@/app/(models)/Ticket"; // instead of "../../(models/Ticket"
import { NextResponse } from "next/server";

export async function POST(req) {
    try {
        const body = await req.json();
        const ticketData = body.formData;
        await Ticket.create(ticketData)
        
        return NextResponse.json({message: "Ticket created"}, { status: 201})
    } catch (error) {
        return NextResponse.json({message: "Error", error}, { status: 500})
    }
}
```

- Create a TicketForm component (app/components)
``` javascript
"use client"; // explicit use of client javascript

import { useRouter } from "next/navigation"
import React, {useState} from "react"

const TicketForm = () => {

    const handleChange = (e) => {
        const value = e.target.value
        const name = e.target.name

        setFormData((prevState) => ({
            ...prevState,
            [name]: value,
        }));
    };

    const startingTicketData = {
        title: "",
        description: "",
        priority: 1,
        progress: 0,
        status: "not started",
        category: "Hadware Problem"
    };

    const [formData, setFormData] = useState(startingTicketData);

  return (
    <div className="flex justify-center">
        <form>
            <h3>Create Your Ticket</h3>
            <label htmlFor="">Title</label>
            <input 
                id="title" 
                name="title" 
                type="text" 
                onChange={handleChange} 
                required={true} 
                value={formData.title} />
        </form>
    </div>
  )
}

export default TicketForm
```

- Insert Form in TicketPage component (new Ticket) and access it in browser (ticket icon displays the form !)
``` javascript
import TicketForm from "@/app/(components)/TicketForm"

const TicketPage = ({ params }) => {
  return (
    <TicketForm />
  )
}

export default TicketPage
```

- Add style to globals.css
``` css
form {
    @apply rounded-xl p-4;
}
label {
    @apply mt-4;
}
input, select, textarea {
    @apply m-1 rounded bg-card p-1;
}
```

- Add form elements (textarea, ...) and handleSubmit method
``` javascript
const TicketForm = () => {

    const handleChange = (e) => {
        const value = e.target.value
        const name = e.target.name

        setFormData((prevState) => ({
            ...prevState,
            [name]: value,
        }));
    };

    const handleSubmit = () => {
        //console.log("submitted");
    }

    const startingTicketData = {
        title: "",
        description: "",
        priority: 1,
        progress: 0,
        status: "not started",
        category: "Hadware Problem"
    };

    const [formData, setFormData] = useState(startingTicketData);

  return (
    <div className="flex justify-center">
        <form className="flex flex-col gap-3 w-1/2" method="post" onSubmit={handleSubmit} >
            <h3>Create Your Ticket</h3>
            <label htmlFor="">Title</label>
            <input 
                id="title" 
                name="title" 
                type="text" 
                onChange={handleChange} 
                required={true} 
                value={formData.title} 
            />
            <label htmlFor="">Description</label>
            <textarea 
                id="description" 
                name="description" 
                onChange={handleChange} 
                required={true} 
                value={formData.description} 
                rows="5"
            />

            <label htmlFor="">Category</label>
            <select 
                id="category"
                name="category"
                value={formData.category}
                onChange={handleChange} 
                >
                <option value="Hardware Problem">Hardware Problem</option>
                <option value="Software Problem">Software Problem</option>
                <option value="Project">Project</option>
            </select>

            <label htmlFor="">Priority</label>
            <div>
                <input 
                    id="priority-1"
                    name="priority"
                    type="radio" 
                    onChange={handleChange}
                    value={1}
                    checked={formData.priority == 1} 
                />
                <label htmlFor="">1</label>
                <input 
                    id="priority-2"
                    name="priority"
                    type="radio" 
                    onChange={handleChange}
                    value={2}
                    checked={formData.priority == 2} 
                />
                <label htmlFor="">2</label>
                <input 
                    id="priority-3"
                    name="priority"
                    type="radio" 
                    onChange={handleChange}
                    value={3}
                    checked={formData.priority == 3} 
                />
                <label htmlFor="">3</label>
                <input 
                    id="priority-4"
                    name="priority"
                    type="radio" 
                    onChange={handleChange}
                    value={4}
                    checked={formData.priority == 4} 
                />
                <label htmlFor="">4</label>
                <input 
                    id="priority-5"
                    name="priority"
                    type="radio" 
                    onChange={handleChange}
                    value={5}
                    checked={formData.priority == 5} 
                />
                <label htmlFor="">5</label>
            </div>

            <label htmlFor="">Progress</label>
            <input 
                type="range" 
                name="progress" 
                id="progress" 
                value={formData.progress}
                min="0"
                max="100"
                onChange={handleChange}
            />

            <label htmlFor="">Status</label>
            <select 
                name="status" 
                id="status"
                value={formData.status}
                onChange={handleChange}
            >
                <option value="not started">Not Started</option>
                <option value="started">Started</option>
                <option value="done">Done</option>
            </select>

            <input 
                className="btn"
                value="Create Ticket"
                type="submit" 
            />
        </form>
    </div>
  )
}
```

- Add a GET function in route.js
``` javascript
export async function GET() {
    try {
        const tickets = await Ticket.find();
        return NextResponse.json({ tickets }, { status: 200})
    } catch (error) {
        return NextResponse.json({message: "Error", error}, { status: 500})
    }
}
```

- Update page.js (root folder)
``` javascript
import TicketCard from "./(components)/TicketCard"

const getTickets = async () => {
  try {
    const res = await fetch("http://localhost:3000/api/Tickets", {
      cache: "no-store"
    })

    return res.json();
  } catch (error) {
    console.log("Failed to get tickets", error);
  }
}

const Dashboard = async () => {
  const { tickets } = await getTickets();

  const uniqueCategories = [
    ... new Set(tickets?.map(({category}) => category)),
  ];

  return (
    <div className="p-5">
      <div>
      {tickets && 
        uniqueCategories?.map((uniqueCategory, categoryIndex) => (
        <div key={categoryIndex} className="mb-4">
          <h2>{uniqueCategory}</h2>
          <div className="lg:grid grid-cols-2 xl:grid-cols-4">
            {tickets
            .filter((ticket) => ticket.category === uniqueCategory)
            .map((filteredTicket, _index) => (
              <TicketCard 
                id={_index}
                key={_index}
                ticket={filteredTicket}
              />
            ))}
          </div>
        </div>
      ))}
      </div>
    </div>
  );
};

export default Dashboard
```

- Update PriorityDisplay with dynamic range of priority
``` javascript
import { faFire } from "@fortawesome/free-solid-svg-icons"
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome"

const PriorityDisplay = ({priority}) => {
  return (
    <div className="flex justify-start align-baseline">
        <FontAwesomeIcon 
          icon={faFire} 
          className={`pr-1 ${priority > 0 ? "text-red-400" : "text-slate-400"}`} 
        />
        <FontAwesomeIcon 
          icon={faFire} 
          className={`pr-1 ${priority > 1 ? "text-red-400" : "text-slate-400"}`} 
        />
        <FontAwesomeIcon 
          icon={faFire} 
          className={`pr-1 ${priority > 2 ? "text-red-400" : "text-slate-400"}`} 
        />
        <FontAwesomeIcon 
          icon={faFire} 
          className={`pr-1 ${priority > 3 ? "text-red-400" : "text-slate-400"}`} 
        />
        <FontAwesomeIcon 
          icon={faFire} 
          className={`pr-1 ${priority > 4 ? "text-red-400" : "text-slate-400"}`} 
        />
        
    </div>
  )
}

export default PriorityDisplay
```

- Format datetime in ticket (fr-FR)
``` javascript
const TicketCard = ({ticket}) => {
    
    const formatTimestamp = (timestamp) => {
        const options = {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
        }

        const date = new Date(timestamp)
        const formattedDate = date.toLocaleString("fr-FR", options);

        return formattedDate;
    }
  
    return (
    <div className="flex flex-col bg-card hover:bg-card-hover rounded-md shadow-lg p-3 m-2">
        <div className="flex mb-3">
            <PriorityDisplay priority={ticket.priority} />
            <div className="ml-auto">
                <DeleteBlock />
            </div>
        </div>
        <h4>{ticket.title}</h4>
        <hr className="h-px border-0 bg-page mb-2"/>
        <p className="whitespace-pre-wrap">
            {ticket.description}
        </p>
        <div className="flex-grow"></div>
        <div className="flex mt-2">
            <div className="flex flex-col">
                <p className="text-xs my-1">{formatTimestamp(ticket.createdAt)}</p>
                <ProgressDisplay 
                    progress={ticket.progress}
                />
            </div>
            <div className="ml-auto flex items-end">
                <StatusDisplay 
                    status={ticket.status}
                />
            </div>
        </div>
    </div>
  )
}
```

- Create a new folder [id] and route.js in api/Ticket folder

...route.js
``` javascript
import Ticket from "@/app/(models)/Ticket";
import { NextResponse } from "next/server";

export async function DELETE(req, {params}) {
    try {
        const {id} = params;
        await Ticket.findByIdAndDelete(id);

        return NextResponse.json({message: "Ticket deleted"}, { status: 200 });
    } catch (error) {
        return NextResponse.json({message: "Error", error}, { status: 500 });
    }
}
```
...DeleteBlock.jsx
``` javascript
import { faX } from "@fortawesome/free-solid-svg-icons"
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome"
import { useRouter } from "next/navigation"

const DeleteBlock = ({ id }) => {

  const router = useRouter();

  const deleteTicket = async () => {
    const res = await fetch(`http://localhost:3000/api/Tickets/${id}`, {
      method: "DELETE"
    });

    if(res.ok){
      router.refresh();
    }
    
  }

  return (
    <FontAwesomeIcon 
        icon={faX} 
        className="text-red-400 hover:cursor-pointer hover:text-red-200"
        onClick={deleteTicket}
    />
  )
}

export default DeleteBlock
```

...TicketCard.jsx
``` javascript
<DeleteBlock 
    id={ticket._id}
/>
```

- Add Link to update Ticket
``` javascript
<Link href={`/TicketPage/${ticket._id}`} style={({ display: "contents" })} >
    <h4>{ticket.title}</h4>
    <hr className="h-px border-0 bg-page mb-2"/>
    <p className="whitespace-pre-wrap">
        {ticket.description}
    </p>
    <div className="flex-grow"></div>
    <div className="flex mt-2">
        <div className="flex flex-col">
            <p className="text-xs my-1">{formatTimestamp(ticket.createdAt)}</p>
            <ProgressDisplay 
                progress={ticket.progress}
            />
        </div>
        <div className="ml-auto flex items-end">
            <StatusDisplay 
                status={ticket.status}
            />
        </div>
    </div>
</Link>
```

- Add EDITMODE to TicketPage
``` javascript
import TicketForm from "@/app/(components)/TicketForm"

const getTicketById = async (id) => {

  const res = await fetch(`http://localhost:3000/api/Tickets/${id}`, {
    cache: "no-store"
  })

  if(!res.ok) {
    throw new Error("Failed to get ticket.");
  }

  return res.json();
}

const TicketPage = async ({ params }) => {

  const EDITMODE = params.id === "new" ? false : true;
  let updateTicketData = {}
  
  if(EDITMODE) {
    updateTicketData = await getTicketById(params.id);
    console.log(updateTicketData);
  }

  return (
    <TicketForm />
  )
}

export default TicketPage
```

- Update route.js (in [id] folder)
``` javascript
import Ticket from "@/app/(models)/Ticket";
import { NextResponse } from "next/server";

export async function GET(req, { params }) {
    const { id } = params
    const foundTicket = await Ticket.findOne({ _id: id })
    return NextResponse.json({ foundTicket }, { status: 200 })
}

export async function DELETE(req, { params }) {
    try {
        const { id } = params;
        await Ticket.findByIdAndDelete(id);

        return NextResponse.json({ message: "Ticket deleted" }, { status: 200 });
    } catch (error) {
        return NextResponse.json({ message: "Error", error }, { status: 500 });
    }
}
```

- Finish EDITMODE options (like button and title captions)
``` jsx
<h3>{ EDITMODE ? "Update Your Ticket" : "Create Your Ticket" }</h3>

<input 
    className="btn"
    value={ EDITMODE ? "Update Your Ticket" : "Create Your Ticket"}
    type="submit" 
/>
```

- Add PUT function in route.js
``` javascript
export async function PUT(req, { params }) {
    try {
        const { id } = params;
        const body = await req.json()
        const ticketData = body.formData

        const updateTicketData = await Ticket.findByIdAndUpdate(id, {
            ...ticketData
        });

        return NextResponse.json({ message: "Ticket updated" }, { status: 200 });
    } catch (error) {
        return NextResponse.json({ message: "Error", error }, { status: 500 });
    }
}
```

- Update TicketPage
``` javascript
import TicketForm from "@/app/(components)/TicketForm"

const getTicketById = async (id) => {
  try {
    const res = await fetch(`http://localhost:3000/api/Tickets/${id}`, {
      cache: "no-store",
    });

    if (!res.ok) {
      throw new Error("Failed to fetch topic");
    }

    return res.json();
  } catch (error) {
    console.log(error);
  }
};

let updateTicketData = {}
const TicketPage = async ({ params }) => {

  const EDITMODE = params.id === "new" ? false : true;
  
  if(EDITMODE) {
    updateTicketData = await getTicketById(params.id);
    updateTicketData = updateTicketData.foundTicket;
  } else {
    updateTicketData = {
      _id: "new",
    }
  }
  
  return <TicketForm ticket={ updateTicketData } />;
}

export default TicketPage
```

- Ordet by tickets by creation date ASC on homepage
``` javascript
export async function GET() {
    try {
        // get all tickets order by createdAt ASC
        const tickets = await Ticket.find().sort( { createdAt: 1 } );
        return NextResponse.json({ tickets }, { status: 200})
    } catch (error) {
        return NextResponse.json({message: "Error", error}, { status: 500})
    }
}
```